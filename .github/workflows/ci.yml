name: ğŸ” CI - Tests et Validation

on:
  push:
    branches: [ main, develop, swing ]
  pull_request:
    branches: [ main, develop, swing ]

jobs:
  test:
    name: ğŸ§ª Tests Multi-OS
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        java-version: [21]

    runs-on: ${{ matrix.os }}

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: â˜• Configuration Java ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'
          cache: maven

      - name: ğŸ” Information systÃ¨me
        run: |
          echo "=== SystÃ¨me ==="
          echo "OS: ${{ matrix.os }}"
          echo "Java: ${{ matrix.java-version }}"
          echo ""
          echo "=== Versions ==="
          java -version
          mvn --version

      - name: ğŸ§ª Compilation et tests
        run: mvn clean compile test

      - name: ğŸ“¦ Build des JARs
        run: mvn clean package -DskipTests

      - name: ğŸ” VÃ©rification des artefacts
        shell: bash
        run: |
          echo "=== JARs gÃ©nÃ©rÃ©s ==="
          find target/ -name "*.jar" -type f -exec ls -lh {} \;
          
          echo ""
          echo "=== VÃ©rification de la structure du JAR principal ==="
          JAR_FILE=$(find target/ -name "*jar-with-dependencies.jar" -type f | head -1)
          if [ -n "$JAR_FILE" ]; then
            echo "JAR trouvÃ©: $JAR_FILE"
            java -jar "$JAR_FILE" --help 2>/dev/null || echo "Mode headless OK"
          else
            echo "âŒ JAR avec dÃ©pendances non trouvÃ©"
            exit 1
          fi

      - name: ğŸ“Š Upload des artefacts de build
        uses: actions/upload-artifact@v4
        if: matrix.os == 'ubuntu-latest'
        with:
          name: jar-artifacts
          path: |
            target/*.jar
            run.bat
            run.sh
          retention-days: 30

  security-scan:
    name: ğŸ” Scan de SÃ©curitÃ©
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: â˜• Configuration Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ğŸ” Scan des vulnÃ©rabilitÃ©s Maven
        run: mvn org.owasp:dependency-check-maven:check

      - name: ğŸ“Š Upload du rapport de sÃ©curitÃ©
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: target/dependency-check-report.html
          retention-days: 30

  code-quality:
    name: ğŸ“ QualitÃ© du Code
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: â˜• Configuration Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ğŸ“Š Analyse de qualitÃ© avec SpotBugs
        run: mvn compile spotbugs:spotbugs

      - name: ğŸ“Š Upload du rapport SpotBugs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: spotbugs-report
          path: target/spotbugsXml.xml
          retention-days: 30

  validate-scripts:
    name: ğŸ”§ Validation des Scripts
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ” Validation du script Bash
        run: |
          if [ -f "run.sh" ]; then
            echo "âœ… run.sh trouvÃ©"
            # VÃ©rifier la syntaxe bash
            bash -n run.sh
            echo "âœ… Syntaxe run.sh valide"
          else
            echo "âŒ run.sh manquant"
            exit 1
          fi

      - name: ğŸ” Validation du script Batch (syntaxe de base)
        run: |
          if [ -f "run.bat" ]; then
            echo "âœ… run.bat trouvÃ©"
            # VÃ©rifications de base pour le script batch
            if grep -q "mvn" run.bat; then
              echo "âœ… Script batch contient les commandes Maven"
            else
              echo "âŒ Script batch ne contient pas les commandes Maven"
              exit 1
            fi
          else
            echo "âŒ run.bat manquant"
            exit 1
          fi

  performance-test:
    name: âš¡ Tests de Performance
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: â˜• Configuration Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ğŸ“¦ Build optimisÃ©
        run: mvn clean package -DskipTests -Dmaven.compiler.optimize=true

      - name: âš¡ Test de dÃ©marrage et consommation mÃ©moire
        run: |
          echo "=== Test de performance de dÃ©marrage ==="
          JAR_FILE=$(find target/ -name "*jar-with-dependencies.jar" -type f | head -1)
          
          if [ -n "$JAR_FILE" ]; then
            echo "Test avec: $JAR_FILE"
            echo "Taille du JAR: $(du -sh "$JAR_FILE")"
          
            # Test de dÃ©marrage en mode headless avec timeout
            echo "Test de dÃ©marrage (10s max)..."
            timeout 10s java -Djava.awt.headless=true -Xmx128m -jar "$JAR_FILE" || echo "âœ… DÃ©marrage OK (timeout attendu)"
          
            echo "âœ… Tests de performance terminÃ©s"
          else
            echo "âŒ JAR non trouvÃ© pour les tests de performance"
            exit 1
          fi

  integration-test:
    name: ğŸ”— Tests d'IntÃ©gration
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: â˜• Configuration Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ğŸ“¦ Build du projet
        run: mvn clean package -DskipTests

      - name: ğŸŒ Test de connectivitÃ© aux APIs
        run: |
          echo "=== Test de connectivitÃ© aux APIs de traduction ==="
          
          # Test MyMemory API
          echo "Test MyMemory API..."
          curl -f "https://api.mymemory.translated.net/get?q=hello&langpair=en|fr" || echo "âš ï¸ MyMemory API inaccessible"
          
          # Test Google Translate API
          echo "Test Google Translate API..."
          curl -f "https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=fr&dt=t&q=hello" || echo "âš ï¸ Google Translate API inaccessible"
          
          # Test OCR.space API
          echo "Test OCR.space API..."
          curl -f "https://api.ocr.space/" || echo "âš ï¸ OCR.space API inaccessible"
          
          echo "âœ… Tests de connectivitÃ© terminÃ©s"

      - name: ğŸ“ Test de crÃ©ation des dossiers
        run: |
          echo "=== Test de crÃ©ation du dossier logs ==="
          JAR_FILE=$(find target/ -name "*jar-with-dependencies.jar" -type f | head -1)
          
          if [ -n "$JAR_FILE" ]; then
            # Lancer l'app en mode headless pour 5 secondes
            timeout 5s java -Djava.awt.headless=true -jar "$JAR_FILE" || true
          
            # VÃ©rifier si le dossier logs est crÃ©Ã©
            if [ -d "logs" ]; then
              echo "âœ… Dossier logs crÃ©Ã© automatiquement"
              ls -la logs/ || echo "Dossier logs vide (normal)"
            else
              echo "âš ï¸ Dossier logs non crÃ©Ã© (peut Ãªtre normal en mode headless)"
            fi
          fi
